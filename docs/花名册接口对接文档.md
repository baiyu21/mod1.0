# 花名册接口对接文档

## 概述

本文档详细说明器乐报名页面中花名册（指导教师和参赛人员）的接口对接实现方法，包括组件封装、数据转换、接口调用等完整流程。

## 目录

1. [组件架构](#组件架构)
2. [列定义封装](#列定义封装)
3. [数据转换逻辑](#数据转换逻辑)
4. [接口对接步骤](#接口对接步骤)
5. [常见问题解决](#常见问题解决)
6. [最佳实践](#最佳实践)

---

## 组件架构

### 组件层次结构

```
EntryFormInstrumental.vue (器乐报名页面)
  ├── TeacherBlock.vue (指导教师组件)
  │   └── RosterBlock.vue (通用花名册组件)
  └── MemberBlock.vue (参赛人员组件)
      └── RosterBlock.vue (通用花名册组件)
```

### 组件说明

#### 1. `RosterBlock.vue` - 通用花名册组件
- **功能**：提供表格展示、新增行、删除行、批量导入、数据验证等功能
- **位置**：`mod1.0/src/components/RosterBlock.vue`
- **Props**：
  - `title: string` - 花名册标题
  - `columns: Column[]` - 列定义数组
  - `rows: RosterItem[]` - 花名册数据（v-model）
  - `readonly?: boolean` - 是否只读
- **Events**：
  - `update:rows` - 数据更新事件

#### 2. `TeacherBlock.vue` - 指导教师封装组件
- **功能**：封装指导教师专用的列定义和数据同步逻辑
- **位置**：`mod1.0/src/components/TeacherBlock.vue`
- **特点**：使用 `teacherColumns` 列定义，自动处理数据同步

#### 3. `MemberBlock.vue` - 参赛人员封装组件
- **功能**：封装参赛人员专用的列定义和数据同步逻辑
- **位置**：`mod1.0/src/components/MemberBlock.vue`
- **特点**：使用 `memberColumnsFull` 列定义（完整版，包含所有字段和下拉选择）

---

## 列定义封装

### 文件位置
`mod1.0/src/composables/useRosterColumns.ts`

### 导出的列定义

#### 1. `teacherColumns` - 指导教师列定义
按照接口文档要求排序：
1. 姓名 (`name`)
2. 身份证号 (`idNo`)
3. 民族 (`nation`)
4. 年龄 (`age`)
5. 性别 (`gender`) - 下拉选择
6. 所在地区 (`region`)
7. 学校名称 (`school`)
8. 所在院系/部门 (`org`)
9. 联系方式 (`phone`)

#### 2. `memberColumnsFull` - 参赛人员列定义（完整版）
按照接口文档要求排序：
1. 姓名 (`name`)
2. 身份证号 (`idNo`)
3. 民族 (`nation`)
4. 年龄 (`age`)
5. 性别 (`gender`) - 下拉选择
6. 所在地区 (`region`)
7. 学校名称 (`school`)
8. 所在院系 (`dept`)
9. 年级 (`grade`) - 下拉选择
10. 专业类别 (`major`) - 下拉选择
11. 专业名称 (`majorName`)
12. 学号 (`studentNo`)
13. 联系方式 (`phone`)

#### 3. `memberColumns` - 参赛人员列定义（简化版）
用于伴奏等场景，字段与完整版相同，但不包含下拉选择选项。

### 使用方式

```typescript
import { teacherColumns, memberColumns, memberColumnsFull } from '@/composables/useRosterColumns'

// 在组件中使用
<TeacherBlock v-model:rows="teachers" :readonly="readonly" />
<MemberBlock v-model:rows="members" :readonly="readonly" />
<RosterBlock title="学生伴奏" :columns="memberColumns" v-model:rows="studentAccomp" />
```

---

## 数据转换逻辑

### 文件位置
`mod1.0/src/views/user/EntryFormInstrumental.vue`

### 转换函数

#### 1. `transformGuideTeachers` - 指导教师数据转换

**功能**：将前端花名册数据转换为后端接口要求的格式

**输入**：`RosterItem[]` - 前端花名册数据

**输出**：后端接口格式的数组

**转换规则**：
```typescript
{
  name: String(teacher.name || '').trim(),
  id_card_number: String(teacher.idNo || '').trim() || '000000000000000000',
  ethnicity: nationValue === '汉' ? '汉族' : (nationValue || '汉族'),
  age: Number(teacher.age) || 35,
  gender: teacher.gender === 'male' ? 'male' : 'female',
  region: String(teacher.region || '').trim() || '北京市',
  school_name: String(teacher.school || '').trim() || '未填写',
  department: String(teacher.org || teacher.dept || '').trim() || '未填写',
  phone: String(teacher.phone || '').trim() || '13800000000'
}
```

**关键处理**：
- 民族字段：自动将"汉"转换为"汉族"
- 默认值：所有字段都有默认值，确保不会提交空值
- 过滤：只包含有姓名的记录

#### 2. `transformParticipants` - 参赛人员数据转换

**功能**：将前端花名册数据转换为后端接口要求的格式

**输入**：`RosterItem[]` - 前端花名册数据

**输出**：后端接口格式的数组

**转换规则**：
```typescript
{
  name: String(member.name || '').trim(),
  id_card_number: String(member.idNo || '').trim() || '000000000000000000',
  ethnicity: nationValue === '汉' ? '汉族' : (nationValue || '汉族'),
  age: Number(member.age) || 20,
  gender: member.gender === 'male' ? 'male' : 'female',
  region: String(member.region || '').trim() || '北京市',
  school_name: String(member.school || '').trim() || '未填写',
  department: String(member.dept || '').trim() || '未填写',
  grade: String(member.grade || '').trim() || '大四',
  major_category: String(member.major || '').trim() || '艺术',
  major_name: String(member.majorName || member.major || '').trim() || '未填写',
  student_id: String(member.studentId || member.studentNo || '').trim() || '20200001',
  phone: String(member.phone || '').trim() || '13800000000'
}
```

**关键处理**：
- 专业名称：优先使用 `majorName`，如果没有则使用 `major`
- 学号：兼容 `studentId` 和 `studentNo` 两种字段名
- 默认值：所有字段都有默认值

---

## 接口对接步骤

### 步骤 1：在页面中引入组件

```vue
<template>
  <el-card shadow="never" class="ef-section-card sec-4">
    <template #header>
      <div class="ef-card-title"><span>报名花名册</span></div>
    </template>
    <TeacherBlock v-model:rows="teachers" :readonly="readonly" />
    <MemberBlock class="ef-mt16" v-model:rows="members" :readonly="readonly" />
  </el-card>
</template>

<script lang="ts" setup>
import TeacherBlock from '@/components/TeacherBlock.vue'
import MemberBlock from '@/components/MemberBlock.vue'

const teachers = ref<RosterItem[]>([])
const members = ref<RosterItem[]>([])
</script>
```

### 步骤 2：定义数据转换函数

```typescript
// 指导教师转换
const transformGuideTeachers = (teachers: RosterItem[]) => {
  return teachers
    .filter(teacher => {
      const nameValue = teacher.name || ''
      return nameValue && String(nameValue).trim()
    })
    .map(teacher => {
      const nationValue = String(teacher.nation || '').trim()
      const ethnicity = nationValue === '汉' ? '汉族' : (nationValue || '汉族')
      
      return {
        name: String(teacher.name || '').trim(),
        id_card_number: String(teacher.idNo || '').trim() || '000000000000000000',
        ethnicity: ethnicity,
        age: Number(teacher.age) || 35,
        gender: teacher.gender === 'male' ? 'male' : 'female',
        region: String(teacher.region || '').trim() || '北京市',
        school_name: String(teacher.school || '').trim() || '未填写',
        department: String(teacher.org || teacher.dept || '').trim() || '未填写',
        phone: String(teacher.phone || '').trim() || '13800000000'
      }
    })
}

// 参赛人员转换
const transformParticipants = (members: RosterItem[]) => {
  return members
    .filter(member => {
      const nameValue = member.name || ''
      return nameValue && String(nameValue).trim()
    })
    .map(member => {
      const nationValue = String(member.nation || '').trim()
      const ethnicity = nationValue === '汉' ? '汉族' : (nationValue || '汉族')
      
      return {
        name: String(member.name || '').trim(),
        id_card_number: String(member.idNo || '').trim() || '000000000000000000',
        ethnicity: ethnicity,
        age: Number(member.age) || 20,
        gender: member.gender === 'male' ? 'male' : 'female',
        region: String(member.region || '').trim() || '北京市',
        school_name: String(member.school || '').trim() || '未填写',
        department: String(member.dept || '').trim() || '未填写',
        grade: String(member.grade || '').trim() || '大四',
        major_category: String(member.major || '').trim() || '艺术',
        major_name: String(member.majorName || member.major || '').trim() || '未填写',
        student_id: String(member.studentId || member.studentNo || '').trim() || '20200001',
        phone: String(member.phone || '').trim() || '13800000000'
      }
    })
}
```

### 步骤 3：在提交函数中调用转换和接口

```typescript
const onSubmit = async () => {
  // 1. 表单验证
  if (!baseForm.notice) {
    ElMessage.warning('请先阅读并同意报名须知')
    return
  }
  
  const valid = await formRef.value.validate().catch(() => false)
  if (!valid) {
    ElMessage.warning('请填写完整的表单信息')
    return
  }
  
  // 2. 转换花名册数据
  const guideTeachersData = transformGuideTeachers(teachers.value)
  const participantsData = transformParticipants(members.value)
  
  // 3. 验证花名册数据
  if (participantsData.length === 0) {
    ElMessage.warning('请至少添加一个参赛人员')
    return
  }
  
  // 4. 构建接口数据
  const apiData = {
    work_file: workFile,
    work_title: baseForm.workName || '',
    performance_type: mapPerformanceType(baseForm.performanceType),
    duration_minutes: baseForm.minutes || 0,
    duration_seconds: baseForm.seconds || 0,
    performer_count: baseForm.count || members.value.length || 1,
    contact_name: baseForm.contact || '',
    contact_phone: baseForm.phone || '',
    contact_address: baseForm.address || '',
    group_type: mapGroupType(baseForm.group),
    is_original: baseForm.isOriginal || false,
    work_description: intro.value || '',
    status: 'draft',
    guide_teachers: guideTeachersData,  // 转换后的指导教师数据
    participants: participantsData,      // 转换后的参赛人员数据
    conductor: {
      conductor_choice: '学生指挥'
    }
  }
  
  // 5. 调用接口
  try {
    const success = await registrationApi.submitInstrumental(apiData)
    if (success) {
      ElMessage.success('提交成功')
      // 处理成功后的逻辑
    } else {
      ElMessage.error('提交失败，请重试')
    }
  } catch (error) {
    console.error('提交失败:', error)
    ElMessage.error('提交失败，请稍后再试')
  }
}
```

---

## 常见问题解决

### 问题 1：新增行后数据无法输入

**症状**：点击"新增一行"后，输入框无法输入数据

**原因**：数据同步逻辑导致用户输入被覆盖

**解决方案**：
1. 在 `TeacherBlock`/`MemberBlock` 中添加 `isSyncing` 标志
2. 在更新 `localRows` 时设置 `isSyncing = true`，防止触发循环更新
3. 使用 `JSON.stringify` 比较数据是否真正改变

**相关代码**：
```typescript
// TeacherBlock.vue / MemberBlock.vue
watch(() => props.rows, (v) => {
  if (isSyncing) return
  const newRows = v ? JSON.parse(JSON.stringify(v)) : []
  const currentStr = JSON.stringify(localRows.value)
  const newStr = JSON.stringify(newRows)
  if (currentStr !== newStr) {
    isSyncing = true
    localRows.value = newRows
    setTimeout(() => {
      isSyncing = false
    }, 0)
  }
}, { deep: true })
```

### 问题 2：提交时花名册数据为空数组

**症状**：提交时 `guide_teachers` 和 `participants` 为空数组

**原因**：
1. 用户输入的数据没有正确同步到父组件
2. 转换函数过滤掉了所有记录（因为没有姓名）

**解决方案**：
1. 确保 `RosterBlock` 的 watch 正确同步数据
2. 在转换函数中添加调试日志，检查原始数据
3. 确保用户至少填写了姓名字段

**调试代码**：
```typescript
console.log('[onSubmit] 原始花名册数据:', {
  teachers: teachers.value,
  members: members.value,
  teachersCount: teachers.value.length,
  membersCount: members.value.length
})

if (teachers.value.length > 0) {
  console.log('[onSubmit] 第一条教师数据详情:', JSON.parse(JSON.stringify(teachers.value[0])))
  console.log('[onSubmit] 第一条教师数据的所有键:', Object.keys(teachers.value[0] || {}))
}
```

### 问题 3：字段映射错误

**症状**：后端接收到的字段名或值不正确

**原因**：前端字段名与后端要求不一致

**解决方案**：
1. 检查 `useRosterColumns.ts` 中的列定义是否与接口文档一致
2. 检查转换函数中的字段映射是否正确
3. 确保所有必需字段都有默认值

**字段映射对照表**：

| 前端字段 | 后端字段 | 说明 |
|---------|---------|------|
| `name` | `name` | 姓名 |
| `idNo` | `id_card_number` | 身份证号 |
| `nation` | `ethnicity` | 民族（自动转换"汉"为"汉族"） |
| `age` | `age` | 年龄 |
| `gender` | `gender` | 性别（male/female） |
| `region` | `region` | 所在地区 |
| `school` | `school_name` | 学校名称 |
| `org`/`dept` | `department` | 所在院系/部门 |
| `phone` | `phone` | 联系方式 |
| `grade` | `grade` | 年级（仅参赛人员） |
| `major` | `major_category` | 专业类别（仅参赛人员） |
| `majorName` | `major_name` | 专业名称（仅参赛人员） |
| `studentNo`/`studentId` | `student_id` | 学号（仅参赛人员） |

### 问题 4：递归更新错误

**症状**：控制台报错 "Maximum recursive updates exceeded"

**原因**：watch 循环触发导致无限更新

**解决方案**：
1. 使用 `isSyncing` 标志防止循环更新
2. 使用 `JSON.stringify` 比较数据是否真正改变
3. 在更新数据时临时设置 `isSyncing = true`

---

## 最佳实践

### 1. 数据同步机制

- **使用 `isSyncing` 标志**：防止循环更新
- **数据比较**：使用 `JSON.stringify` 比较数据是否真正改变
- **延迟重置**：使用 `setTimeout` 或 `nextTick` 延迟重置同步标志

### 2. 默认值处理

- **所有字段都有默认值**：确保不会提交空值或 undefined
- **民族字段特殊处理**：自动将"汉"转换为"汉族"
- **兼容多种字段名**：如 `studentId` 和 `studentNo`、`org` 和 `dept`

### 3. 数据验证

- **过滤空记录**：只包含有姓名的记录
- **提交前验证**：至少需要一个参赛人员
- **字段验证**：在 `RosterBlock` 中实现实时字段验证

### 4. 调试技巧

- **添加详细日志**：在转换函数中添加 `console.log` 输出原始数据和转换后数据
- **检查数据键**：使用 `Object.keys()` 检查数据对象的所有键
- **逐步调试**：先检查原始数据，再检查转换后数据，最后检查接口响应

### 5. 代码复用

- **使用封装的组件**：`TeacherBlock` 和 `MemberBlock` 已封装好列定义和同步逻辑
- **使用封装的列定义**：从 `useRosterColumns.ts` 导入列定义
- **转换函数可复用**：`transformGuideTeachers` 和 `transformParticipants` 可在其他页面复用

---

## 完整示例

### 器乐报名页面完整实现

```vue
<template>
  <!-- 花名册部分 -->
  <el-card shadow="never" class="ef-section-card sec-4">
    <template #header>
      <div class="ef-card-title"><span>报名花名册</span></div>
    </template>
    <TeacherBlock v-model:rows="teachers" :readonly="readonly" />
    <MemberBlock class="ef-mt16" v-model:rows="members" :readonly="readonly" />
  </el-card>
</template>

<script lang="ts" setup>
import { ref } from 'vue'
import { ElMessage } from 'element-plus'
import TeacherBlock from '@/components/TeacherBlock.vue'
import MemberBlock from '@/components/MemberBlock.vue'
import { registrationApi } from '@/services/api'

interface RosterItem {
  name?: string
  idNo?: string
  nation?: string
  age?: number | string
  gender?: 'male' | 'female'
  region?: string
  school?: string
  org?: string
  dept?: string
  phone?: string
  grade?: string
  major?: string
  majorName?: string
  studentNo?: string
  studentId?: string
}

const teachers = ref<RosterItem[]>([])
const members = ref<RosterItem[]>([])

// 数据转换函数
const transformGuideTeachers = (teachers: RosterItem[]) => {
  return teachers
    .filter(teacher => teacher.name && String(teacher.name).trim())
    .map(teacher => {
      const nationValue = String(teacher.nation || '').trim()
      const ethnicity = nationValue === '汉' ? '汉族' : (nationValue || '汉族')
      
      return {
        name: String(teacher.name || '').trim(),
        id_card_number: String(teacher.idNo || '').trim() || '000000000000000000',
        ethnicity: ethnicity,
        age: Number(teacher.age) || 35,
        gender: teacher.gender === 'male' ? 'male' : 'female',
        region: String(teacher.region || '').trim() || '北京市',
        school_name: String(teacher.school || '').trim() || '未填写',
        department: String(teacher.org || teacher.dept || '').trim() || '未填写',
        phone: String(teacher.phone || '').trim() || '13800000000'
      }
    })
}

const transformParticipants = (members: RosterItem[]) => {
  return members
    .filter(member => member.name && String(member.name).trim())
    .map(member => {
      const nationValue = String(member.nation || '').trim()
      const ethnicity = nationValue === '汉' ? '汉族' : (nationValue || '汉族')
      
      return {
        name: String(member.name || '').trim(),
        id_card_number: String(member.idNo || '').trim() || '000000000000000000',
        ethnicity: ethnicity,
        age: Number(member.age) || 20,
        gender: member.gender === 'male' ? 'male' : 'female',
        region: String(member.region || '').trim() || '北京市',
        school_name: String(member.school || '').trim() || '未填写',
        department: String(member.dept || '').trim() || '未填写',
        grade: String(member.grade || '').trim() || '大四',
        major_category: String(member.major || '').trim() || '艺术',
        major_name: String(member.majorName || member.major || '').trim() || '未填写',
        student_id: String(member.studentId || member.studentNo || '').trim() || '20200001',
        phone: String(member.phone || '').trim() || '13800000000'
      }
    })
}

// 提交函数
const onSubmit = async () => {
  // 转换数据
  const guideTeachersData = transformGuideTeachers(teachers.value)
  const participantsData = transformParticipants(members.value)
  
  // 验证
  if (participantsData.length === 0) {
    ElMessage.warning('请至少添加一个参赛人员')
    return
  }
  
  // 构建接口数据
  const apiData = {
    // ... 其他字段
    guide_teachers: guideTeachersData,
    participants: participantsData,
    // ...
  }
  
  // 调用接口
  const success = await registrationApi.submitInstrumental(apiData)
  if (success) {
    ElMessage.success('提交成功')
  }
}
</script>
```

---

## 总结

通过组件封装、列定义统一管理和数据转换函数的标准化，实现了花名册接口的可靠对接。关键点：

1. **组件封装**：`TeacherBlock` 和 `MemberBlock` 封装了列定义和同步逻辑
2. **列定义统一**：`useRosterColumns.ts` 统一管理所有列定义
3. **数据转换**：标准化的转换函数确保数据格式正确
4. **同步机制**：使用 `isSyncing` 标志防止循环更新
5. **默认值处理**：所有字段都有默认值，确保不会提交空值

按照本文档的步骤，可以快速在其他页面（如舞蹈、戏曲、朗诵等）中实现花名册接口对接。

