# 文件上传组件使用文档

## 概述

`FileUploadBlock.vue` 是一个集成了文件上传功能的通用组件，支持自动上传、手动上传、上传进度跟踪等功能。所有使用该组件的页面都可以统一使用上传功能，无需在每个页面单独处理上传逻辑。

## 组件位置

`mod1.0/src/components/FileUploadBlock.vue`

## 功能特性

1. **自动上传**：支持选择文件后立即上传（可选）
2. **手动上传**：提供方法供父组件手动触发上传
3. **上传进度**：自动跟踪上传状态
4. **URL 管理**：自动管理文件 URL，避免重复上传
5. **事件通知**：提供上传成功/失败/完成事件
6. **类别支持**：支持不同类别的上传接口（vocal, instrumental, dance 等）

## Props

| 属性名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `modelValue` | `UploadFiles \| FileItem[]` | - | 文件列表（v-model，必填） |
| `accept` | `string` | `'.mp3,.wav,.pdf,.jpg,.jpeg,.png'` | 文件类型限制 |
| `limit` | `number` | `6` | 文件数量限制 |
| `tip` | `string` | `'支持多媒体、文档、图片等多种格式...'` | 提示文本 |
| `readonly` | `boolean` | `false` | 是否只读（禁用上传） |
| `uploadText` | `string` | `'将文件拖到此处，或 <em>点击上传</em>'` | 上传区域文本（支持 HTML） |
| `uploadClass` | `string` | `'ef-upload-block'` | 上传组件样式类名 |
| `autoUpload` | `boolean` | `false` | 是否自动上传（选择文件后立即上传） |
| `uploadCategory` | `string` | `'vocal'` | 上传类别（用于选择上传接口路径） |

## Events

| 事件名 | 参数 | 说明 |
|--------|------|------|
| `update:modelValue` | `files: UploadFiles \| FileItem[]` | 文件列表更新事件 |
| `upload-success` | `file: File, url: string` | 单个文件上传成功事件 |
| `upload-error` | `file: File, error: string` | 单个文件上传失败事件 |
| `upload-complete` | `urls: string[]` | 所有文件上传完成事件 |

## 暴露的方法

通过 `ref` 可以调用以下方法：

### `uploadAllFiles()`

手动触发上传所有未上传的文件。

**返回值**: `Promise<string[]>` - 所有文件的 URL 列表

**使用示例**:
```typescript
const fileUploadRef = ref<InstanceType<typeof FileUploadBlock>>()

// 上传所有文件
const urls = await fileUploadRef.value?.uploadAllFiles()
if (urls && urls.length > 0) {
  console.log('上传成功，文件URLs:', urls)
}
```

### `getFirstFileUrl()`

获取第一个文件的 URL（用于报名接口的 `work_file` 字段）。

**返回值**: `string | null` - 第一个文件的 URL，如果没有则返回 `null`

**使用示例**:
```typescript
const fileUploadRef = ref<InstanceType<typeof FileUploadBlock>>()

// 获取第一个文件的URL
const fileUrl = fileUploadRef.value?.getFirstFileUrl()
if (fileUrl) {
  console.log('文件URL:', fileUrl)
}
```

## 使用示例

### 基础用法（不自动上传）

```vue
<template>
  <FileUploadBlock
    ref="fileUploadRef"
    v-model="fileList"
    :accept="'.mp3,.wav,.pdf,.jpg,.jpeg,.png'"
    :limit="6"
    :upload-category="'instrumental'"
    tip="音频、乐谱、图片、视频等多格式支持，所有作品资料请合规提交。"
  />
</template>

<script lang="ts" setup>
import { ref } from 'vue'
import FileUploadBlock, { type FileItem as UploadFileItem } from '@/components/FileUploadBlock.vue'

const fileList = ref<UploadFileItem[]>([])
const fileUploadRef = ref<InstanceType<typeof FileUploadBlock>>()

// 在提交时上传文件
const onSubmit = async () => {
  // 获取第一个文件的URL（如果已上传）
  let workFile = fileUploadRef.value?.getFirstFileUrl()

  if (!workFile) {
    // 如果文件未上传，先上传
    const urls = await fileUploadRef.value?.uploadAllFiles()
    if (urls && urls.length > 0) {
      workFile = urls[0]
    } else {
      ElMessage.error('文件上传失败')
      return
    }
  }

  // 使用 workFile 提交报名数据
  // ...
}
</script>
```

### 自动上传模式

```vue
<template>
  <FileUploadBlock
    v-model="fileList"
    :auto-upload="true"
    :upload-category="'vocal'"
    @upload-complete="handleUploadComplete"
  />
</template>

<script lang="ts" setup>
import { ref } from 'vue'
import FileUploadBlock from '@/components/FileUploadBlock.vue'

const fileList = ref([])

// 所有文件上传完成后触发
const handleUploadComplete = (urls: string[]) => {
  console.log('所有文件上传完成，URLs:', urls)
  // 可以在这里更新表单数据或提交
}
</script>
```

### 监听上传事件

```vue
<template>
  <FileUploadBlock
    v-model="fileList"
    :upload-category="'dance'"
    @upload-success="handleUploadSuccess"
    @upload-error="handleUploadError"
  />
</template>

<script lang="ts" setup>
import FileUploadBlock from '@/components/FileUploadBlock.vue'

const handleUploadSuccess = (file: File, url: string) => {
  console.log('文件上传成功:', file.name, url)
  ElMessage.success(`${file.name} 上传成功`)
}

const handleUploadError = (file: File, error: string) => {
  console.error('文件上传失败:', file.name, error)
  ElMessage.error(`${file.name} 上传失败: ${error}`)
}
</script>
```

## 上传类别映射

| 类别值 | 上传接口路径 | 说明 |
|--------|------------|------|
| `vocal` | `/api/vocal/upload/` | 声乐报名 |
| `instrumental` | `/api/instrumental/upload/` | 器乐报名 |
| `dance` | `/api/dance/upload/` | 舞蹈报名 |
| `opera` | `/api/opera/upload/` | 戏曲报名 |
| `recitation` | `/api/recitation/upload/` | 朗诵报名 |
| 其他 | `/api/{category}/upload/` | 根据传入的 category 动态生成 |

## 在器乐报名页面中的使用

```vue
<template>
  <FileUploadBlock
    ref="fileUploadRef"
    v-model="fileList"
    :accept="accepts"
    :limit="6"
    :readonly="readonly"
    :upload-category="'instrumental'"
    tip="音频、乐谱、图片、视频等多格式支持，所有作品资料请合规提交。"
  />
</template>

<script lang="ts" setup>
import { ref } from 'vue'
import FileUploadBlock, { type FileItem as UploadFileItem } from '@/components/FileUploadBlock.vue'

const fileList = ref<UploadFileItem[]>([])
const fileUploadRef = ref<InstanceType<typeof FileUploadBlock>>()

const onSubmit = async () => {
  // ... 其他验证逻辑 ...

  // 上传文件并获取URL
  let workFile = 'https://example.com/path/to/your/file.mp3' // 默认URL

  if (fileList.value.length > 0) {
    // 先尝试获取已有URL
    const firstFileUrl = fileUploadRef.value?.getFirstFileUrl()

    if (firstFileUrl) {
      workFile = firstFileUrl
    } else {
      // 需要上传文件
      ElMessage.info('正在上传文件，请稍候...')
      const uploadedUrls = await fileUploadRef.value?.uploadAllFiles()

      if (uploadedUrls && uploadedUrls.length > 0 && uploadedUrls[0]) {
        workFile = uploadedUrls[0]
      } else {
        ElMessage.error('文件上传失败，请重试')
        return
      }
    }
  }

  // 使用 workFile 提交报名数据
  const apiData = {
    work_file: workFile,
    // ... 其他字段 ...
  }

  await registrationApi.submitInstrumental(apiData)
}
</script>
```

## 上传流程

1. **用户选择文件** → 文件添加到 `fileList`
2. **自动上传模式**（`autoUpload=true`）:
   - 文件选择后立即调用 `handleUpload`
   - 上传成功后更新文件的 `url` 和 `status`
   - 触发 `upload-success` 事件
   - 所有文件上传完成后触发 `upload-complete` 事件
3. **手动上传模式**（`autoUpload=false`，默认）:
   - 文件选择后不自动上传
   - 父组件调用 `uploadAllFiles()` 方法触发上传
   - 上传流程同上

## 文件 URL 管理

组件会自动管理文件的 URL：

- **已上传的文件**：文件对象中会包含 `url` 属性（以 `http` 开头）
- **未上传的文件**：文件对象中没有 `url` 或 `url` 不是有效的 HTTP URL
- **避免重复上传**：`uploadAllFiles()` 方法会跳过已有 URL 的文件

## 注意事项

1. **向后兼容**：默认 `autoUpload=false`，保持与原有使用方式兼容
2. **类型导入**：如果页面中已有 `FileItem` 类型定义，导入时使用别名避免冲突：
   ```typescript
   import FileUploadBlock, { type FileItem as UploadFileItem } from '@/components/FileUploadBlock.vue'
   ```
3. **上传类别**：确保 `uploadCategory` 与后端接口路径匹配
4. **错误处理**：上传失败时会自动显示错误提示，父组件可以通过事件监听进行额外处理
5. **文件状态**：上传成功后，文件对象的 `status` 会被设置为 `'success'`，`url` 会被设置为上传后的 URL

## 优势

1. **统一管理**：所有上传逻辑集中在组件内部，便于维护
2. **代码复用**：所有页面使用相同的上传逻辑，减少重复代码
3. **易于使用**：提供简单的方法和事件，父组件只需调用即可
4. **类型安全**：完整的 TypeScript 类型定义
5. **灵活配置**：支持自动上传和手动上传两种模式

## 相关文件

- **组件文件**: `mod1.0/src/components/FileUploadBlock.vue`
- **上传 API**: `mod1.0/src/services/api.ts` (uploadApi)
- **上传工具函数**: `mod1.0/src/utils/request.ts` (uploadFile)
- **使用示例**: `mod1.0/src/views/user/EntryFormInstrumental.vue`

