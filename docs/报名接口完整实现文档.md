# 报名接口通用对接文档

## 概述

本文档详细说明所有报名页面的通用接口对接实现方法，包括表单结构、字段映射、数据转换、接口调用、错误处理等全流程。适用于器乐、舞蹈、戏曲、声乐、书法、绘画等所有报名页面。

## 目录

1. [通用接口对接流程](#通用接口对接流程)
2. [通用组件使用](#通用组件使用)
3. [通用数据转换逻辑](#通用数据转换逻辑)
4. [文件上传统一处理](#文件上传统一处理)
5. [各页面特殊处理](#各页面特殊处理)
6. [接口地址汇总](#接口地址汇总)
7. [错误处理](#错误处理)
8. [测试验证](#测试验证)

---

## 通用接口对接流程

### 标准对接步骤

所有报名页面的接口对接都遵循以下标准流程：

1. **导入必要的依赖**
   ```typescript
   import { registrationApi } from '@/services/api'
   import FileUploadBlock from '@/components/FileUploadBlock.vue'
   import TeacherBlock from '@/components/TeacherBlock.vue'
   import MemberBlock from '@/components/MemberBlock.vue'
   ```

2. **添加文件上传引用**
   ```typescript
   const fileUploadRef = ref<InstanceType<typeof FileUploadBlock>>()
   ```

3. **实现数据转换函数**
   - `mapGroupType`: 组别映射（group1 → amateur, group2 → professional）
   - `transformGuideTeachers`: 指导教师数据转换
   - `transformParticipants`: 参演学生数据转换
   - 其他页面特定的映射函数

4. **实现 onSubmit 函数**
   ```typescript
   const onSubmit = async () => {
     // 1. 验证报名须知
     if (!baseForm.notice) {
       ElMessage.warning('请先阅读并同意报名须知')
       return
     }
     
     // 2. 表单验证
     const valid = await formRef.value.validate().catch(() => false)
     if (!valid) return
     
     // 3. 人数限制检查（如适用）
     // ...
     
     // 4. 数据转换
     const guideTeachersData = transformGuideTeachers(teachers.value)
     const participantsData = transformParticipants(members.value)
     
     // 5. 文件上传处理
     let fileUrl = '默认URL'
     if (fileList.value.length > 0) {
       const firstUrl = fileUploadRef.value?.getFirstFileUrl()
       if (firstUrl) {
         fileUrl = firstUrl
       } else {
         const uploadedUrls = await fileUploadRef.value?.uploadAllFiles()
         if (uploadedUrls && uploadedUrls.length > 0) {
           fileUrl = uploadedUrls[0]
         }
       }
     }
     
     // 6. 构建接口数据
     const apiData = { /* ... */ }
     
     // 7. 调用接口
     const success = await registrationApi.submitXXX(apiData)
     if (success) {
       ElMessage.success('提交成功')
       // 保存到 localStorage
     }
   }
   ```

5. **在模板中配置 FileUploadBlock**
   ```vue
   <FileUploadBlock
     ref="fileUploadRef"
     v-model="fileList"
     :accept="accepts"
     :limit="6"
     :readonly="readonly"
     upload-category="xxx"
   />
   ```

---

## 通用组件使用

### 1. FileUploadBlock（文件上传组件）

**用途**：统一管理所有页面的文件上传功能

**配置**：
```vue
<FileUploadBlock
  ref="fileUploadRef"
  v-model="fileList"
  :accept=".mp3,.wav,.pdf,.jpg,.jpeg,.png"
  :limit="6"
  :readonly="readonly"
  upload-category="vocal"  <!-- 根据页面设置：vocal, instrumental, dance, opera, calligraphy, painting -->
/>
```

**关键方法**：
- `getFirstFileUrl()`: 获取第一个已上传文件的URL
- `uploadAllFiles()`: 上传所有文件，返回URL数组

**上传接口**：
- 所有页面统一使用 `/api/vocal/upload/` 接口
- 上传成功后进度条从0%变为100%，显示成功标识

### 2. TeacherBlock（指导教师组件）

**用途**：管理指导教师花名册

**使用**：
```vue
<TeacherBlock v-model:rows="teachers" :readonly="readonly" />
```

**数据转换**：
- 前端字段：`name`, `idNo`, `nation`, `age`, `gender`, `region`, `school`, `org`, `phone`
- 后端字段：`name`, `id_card_number`, `ethnicity`, `age`, `gender`, `region`, `school_name`, `department`, `phone`

### 3. MemberBlock（参演学生组件）

**用途**：管理参演学生花名册

**使用**：
```vue
<MemberBlock v-model:rows="members" :readonly="readonly" />
```

**数据转换**：
- 前端字段：`name`, `idNo`, `nation`, `age`, `gender`, `region`, `school`, `dept`, `grade`, `major`, `majorName`, `studentNo`, `phone`
- 后端字段：`name`, `id_card_number`, `ethnicity`, `age`, `gender`, `region`, `school_name`, `department`, `grade`, `major_category`, `major_name`, `student_id`, `phone`

### 4. ConductorBlock（指挥组件，仅声乐使用）

**用途**：管理指挥花名册（声乐报名专用）

**使用**：
```vue
<ConductorBlock v-model:rows="accomp" :readonly="readonly" />
```

**特殊处理**：
- 声乐报名中，指挥和指导教师合并到 `guide_teachers` 数组
- 通过 `identity` 字段区分：`"teacher"` 或 `"conductor"`

---

## 通用数据转换逻辑

### 1. 组别映射（所有页面通用）

```typescript
const mapGroupType = (group: string): string => {
  const map: Record<string, string> = {
    'group1': 'amateur',      // 甲组(非专业组) → 业余组
    'group2': 'professional'  // 乙组（专业组） → 专业组
  }
  return map[group] || 'amateur'
}
```

### 2. 指导教师数据转换（通用模板）

```typescript
const transformGuideTeachers = (teachers: RosterItem[]): any[] => {
  return teachers
    .filter(teacher => teacher.name && String(teacher.name).trim())
    .map(teacher => {
      // 民族转换：'汉' → '汉族'
      const nationValue = String(teacher.nation || '').trim()
      const ethnicity = nationValue === '汉' ? '汉族' : (nationValue || '汉族')
      
      return {
        name: String(teacher.name || '').trim(),
        id_card_number: String(teacher.idNo || '').trim() || '000000000000000000',
        ethnicity: ethnicity,
        age: Number(teacher.age) || 35,
        gender: teacher.gender === 'male' ? 'male' : (teacher.gender === 'female' ? 'female' : 'male'),
        region: String(teacher.region || '').trim() || '北京市',
        school_name: String(teacher.school || '').trim() || '未填写',
        department: String(teacher.org || teacher.dept || '').trim() || '未填写',
        phone: String(teacher.phone || '').trim() || '13800000000'
        // 注意：声乐报名需要添加 identity: 'teacher'
      }
    })
}
```

### 3. 参演学生数据转换（通用模板）

```typescript
const transformParticipants = (members: RosterItem[]): any[] => {
  return members
    .filter(member => member.name && String(member.name).trim())
    .map(member => {
      // 民族转换：'汉' → '汉族'
      const nationValue = String(member.nation || '').trim()
      const ethnicity = nationValue === '汉' ? '汉族' : (nationValue || '汉族')
      
      return {
        name: String(member.name || '').trim(),
        id_card_number: String(member.idNo || '').trim() || '000000000000000000',
        ethnicity: ethnicity,
        age: Number(member.age) || 20,
        gender: member.gender === 'male' ? 'male' : (member.gender === 'female' ? 'female' : 'male'),
        region: String(member.region || '').trim() || '北京市',
        school_name: String(member.school || '').trim() || '未填写',
        department: String(member.dept || '').trim() || '未填写',
        grade: String(member.grade || '').trim() || '大四',
        major_category: String(member.majorType || '').trim() || '艺术',
        major_name: String(member.majorName || member.major || '').trim() || '未填写',
        student_id: String(member.studentNo || '').trim() || '20200001',
        phone: String(member.phone || '').trim() || '13800000000'
      }
    })
}
```

### 4. 关键处理点

- **民族字段**：必须将"汉"转换为"汉族"
- **性别字段**：必须是 `'male'` 或 `'female'`
- **年龄字段**：必须是数字类型，教师默认35，学生默认20
- **默认值**：所有字段都要有默认值，确保不会提交 `undefined` 或空字符串
- **字段映射**：
  - `idNo` → `id_card_number`
  - `nation` → `ethnicity`
  - `org`/`dept` → `department`
  - `school` → `school_name`
  - `majorType` → `major_category`
  - `majorName`/`major` → `major_name`
  - `studentNo` → `student_id`

---

## 文件上传统一处理

### 上传接口

**统一接口地址**：`/api/vocal/upload/`

所有页面（器乐、舞蹈、戏曲、声乐、书法、绘画）都使用此统一接口。

### 上传流程

```typescript
// 1. 获取已上传文件的URL（如果已上传）
const firstFileUrl = fileUploadRef.value?.getFirstFileUrl()

if (firstFileUrl) {
  // 使用已有URL
  workFile = firstFileUrl
} else {
  // 2. 触发上传
  ElMessage.info('正在上传文件，请稍候...')
  const uploadedUrls = await fileUploadRef.value?.uploadAllFiles()
  
  if (uploadedUrls && uploadedUrls.length > 0 && uploadedUrls[0]) {
    workFile = uploadedUrls[0]
  } else {
    ElMessage.error('文件上传失败，请重试')
    return
  }
}
```

### 上传状态显示

- 文件选择后，进度条从 0% 开始
- 上传成功后，进度条变为 100%，显示成功标识（绿色对勾）
- 上传失败时，显示失败状态

---

## 各页面特殊处理

### 1. 器乐报名 (EntryFormInstrumental.vue)

**接口地址**：`POST /api/instrumental/registrations/`

**特殊字段**：
- `performance_type`: 需要映射（ensemble → ensemble, small-ensemble → small_ensemble, chamber → chamber, solo → solo）
- `conductor.conductor_choice`: 固定为 `'学生指挥'`

**花名册**：
- 指导教师（TeacherBlock）
- 参赛人员（MemberBlock）

### 2. 舞蹈报名 (EntryFormDance.vue)

**接口地址**：`POST /api/dance/registrations/`

**特殊字段**：
- `performance_type`: 需要映射（group-dance → group）
- 其他与器乐类似

**花名册**：
- 指导教师（TeacherBlock）
- 参赛人员（MemberBlock）

### 3. 戏曲报名 (EntryFormOpera.vue)

**接口地址**：`POST /api/opera/registrations/`

**特殊字段**：
- `performance_type`: 需要映射（opera → opera, campus-drama → campus_drama, sketch → sketch, musical-drama → musical_drama, musical → musical）
- 无指挥字段

**花名册**：
- 指导教师（TeacherBlock）
- 参赛人员（MemberBlock）
- 学生伴奏（RosterBlock）
- 老师伴奏（RosterBlock）

### 4. 声乐报名 (EntryFormVocal.vue)

**接口地址**：`POST /api/vocal/api/registrations/`（注意路径中有两个api）

**特殊字段**：
- `performance_type`: 固定为 `'staged'`
- `song1_title`, `song1_is_original`, `song1_is_chinese`: 曲目1信息
- `song2_title`, `song2_is_original`, `song2_is_chinese`: 曲目2信息
- `piano_accompaniment`: 钢琴伴奏（'student' 或 'teacher'）
- `performance_video`: 表演视频URL

**花名册特殊处理**：
- 指导教师和指挥合并到 `guide_teachers` 数组
- 指导教师：`identity: 'teacher'`
- 指挥：`identity: 'conductor'`

**数据转换示例**：
```typescript
// 合并指导教师和指挥
const guideTeachersData = transformGuideTeachers(teachers.value)
const conductorsData = transformConductors(accomp.value)
const allGuideTeachers = [...guideTeachersData, ...conductorsData]
```

### 5. 书法作品 (WorkCalligraphy.vue)

**接口地址**：`POST /api/calligraphy/calligraphy-registrations/`

**特殊字段**：
- `work_title`: 作品名称
- `instructor_name`: 指导教师姓名
- `work_length`, `work_width`: 作品尺寸（cm）
- `creation_date`: 创作时间（YYYY-MM-DD）
- `art_form`: 作品形式（calligraphy 或 seal-carving）
- `work_file`: 作品文件URL
- `author_biography`: 作者简介
- `creation_description`: 创作说明

**花名册**：
- 作者信息（RosterBlock，使用 `authorColumns`）
- 作者数组字段名：`authors`（不是 `participants`）

**数据转换**：
```typescript
const transformAuthors = (rows: RosterItem[]) => {
  return rows
    .filter(row => row.name && String(row.name).trim())
    .map(row => ({
      name: String(row.name || '').trim(),
      id_card_number: String(row.idNo || '').trim() || '000000000000000000',
      region: String(row.region || '').trim() || '未填写',
      school_name: String(row.school || '').trim() || '未填写',
      department: String(row.dept || '').trim() || '未填写',
      major_category: String(row.majorType || '').trim() || '艺术类',
      major_name: String(row.major || '').trim() || '书法专业',
      student_id: String(row.studentNo || '').trim() || '20200001',
      phone: String(row.phone || '').trim() || '13800000000'
    }))
}
```

### 6. 绘画作品 (WorkPainting.vue)

**接口地址**：`POST /painting/api/registrations/`（注意路径前缀不同）

**特殊字段**：
- `work_title`: 作品名称
- `instructor_name`: 指导教师姓名
- `work_length`, `work_width`: 作品尺寸（cm）
- `creation_date`: 创作时间（YYYY-MM-DD）
- `art_form`: 作品形式（需要映射：chinese-painting → chinese_painting, watercolor → watercolor, oil-painting → oil_painting）
- `work_photo`: 作品照片URL（不是 work_file）
- `author_biography`: 作者简介
- `creation_description`: 创作说明
- `is_draft`: 固定为 `false`

**花名册**：
- 作者信息（RosterBlock，需要包含 `gender` 字段）
- 作者数组字段名：`authors`

**数据转换**：
```typescript
const mapArtForm = (formType: string) => {
  const map: Record<string, string> = {
    'chinese-painting': 'chinese_painting',
    'watercolor': 'watercolor',
    'oil-painting': 'oil_painting',
    'other': 'other'
  }
  return map[formType] || formType
}

const transformAuthors = (rows: RosterItem[]) => {
  return rows
    .filter(row => row.name && String(row.name).trim())
    .map(row => ({
      name: String(row.name || '').trim(),
      id_card_number: String(row.idNo || '').trim() || '000000000000000000',
      gender: row.gender === 'male' ? 'male' : (row.gender === 'female' ? 'female' : 'male'),
      region: String(row.region || '').trim() || '未填写',
      school_name: String(row.school || '').trim() || '未填写',
      department: String(row.dept || '').trim() || '未填写',
      major_category: String(row.majorType || '').trim() || '艺术类',
      major_name: String(row.major || '').trim() || '绘画专业',
      student_id: String(row.studentNo || '').trim() || '20200001',
      phone: String(row.phone || '').trim() || '13800000000'
    }))
}
```

### 7. 设计作品 (WorkDesign.vue)

**接口地址**：`POST /design/api/registrations/`（注意路径前缀不同）

**特殊字段**：
- `work_title`: 作品名称
- `instructor_name`: 指导教师姓名
- `contact_name`, `contact_phone`, `contact_address`: 联系信息
- `creation_date`: 创作时间（YYYY-MM-DD格式）
- `work_length`, `work_width`: 作品尺寸（**字符串格式**）
- `art_form`: 作品形式（需要映射为中文：graphic-design → "平面设计", 3d-design → "立体设计"）
- `group_type`: 组别（需要映射为中文：group1 → "甲组", group2 → "乙组"）
- `work_photo`: 作品照片URL（不是 work_file）
- `author_biography`: 作者简介
- `creation_description`: 创作说明

**花名册**：
- 作者信息（RosterBlock，使用 `authorColumns`）
- 作者数组字段名：`authors`

**数据转换**：
```typescript
// 组别映射：前端值 → 后端中文值
const mapGroupType = (group: string): string => {
  const map: Record<string, string> = {
    'group1': '甲组',      // 甲组(非专业组) → 甲组
    'group2': '乙组'       // 乙组（专业组） → 乙组
  }
  return map[group] || '甲组'
}

// 作品形式映射：前端值 → 后端中文值
const mapArtForm = (formType: string): string => {
  const map: Record<string, string> = {
    'graphic-design': '平面设计',
    '3d-design': '立体设计'
  }
  return map[formType] || '平面设计'
}

// 专业类别映射：前端值 → 后端中文值
const mapMajorCategory = (major?: string): string => {
  if (major === 'art') return '艺术类'
  if (major === 'non-art') return '非艺术类'
  if (major && (major === '艺术类' || major === '非艺术类')) {
    return major
  }
  return '艺术类'
}

const transformAuthors = (rows: RosterItem[]) => {
  return rows
    .filter(row => row.name && String(row.name).trim())
    .map(row => ({
      name: String(row.name || '').trim(),
      id_card_number: String(row.idNo || '').trim() || '000000000000000000',
      region: String(row.region || '').trim() || '未填写',
      school_name: String(row.school || '').trim() || '未填写',
      department: String(row.dept || '').trim() || '未填写',
      major_category: mapMajorCategory(row.majorType as string),
      major_name: String(row.major || '').trim() || '设计专业',
      student_id: String(row.studentNo || '').trim() || '20200001',
      phone: String(row.phone || '').trim() || '13800000000'
    }))
}
```

**关键注意事项**：
- `work_length` 和 `work_width` 必须是**字符串格式**，不是数字
- `group_type` 使用中文值（"甲组"、"乙组"），不是英文（"amateur"、"professional"）
- `art_form` 使用中文值（"平面设计"、"立体设计"），不是英文值

### 8. 摄影作品 (WorkPhotography.vue)

**接口地址**：`POST /photography/api/photography-registrations/`（注意路径前缀不同）

**特殊字段**：
- `title`: 作品名称
- `instructor`: 指导教师姓名（不是 `instructor_name`）
- `contact_name`, `contact_phone`, `contact_address`: 联系信息
- `creation_time`: 创作时间（YYYY-MM-DD格式，不是 `creation_date`）
- `work_form`: 作品形式（需要映射：single-photo → "single", group-photo → "group"）
- `width`, `length`: 作品尺寸（**数字格式**，不是字符串）
- `group`: 组别（需要映射：group1 → "group_a", group2 → "group_b"）
- `work_url`: 作品URL（不是 `work_photo`）
- `author_bio`: 作者简介（不是 `author_biography`）
- `creation_intro`: 创作说明（不是 `creation_description`）

**花名册**：
- 作者信息（RosterBlock，使用 `authorColumns`）
- 作者数组字段名：`authors`

**数据转换**：
```typescript
// 作品形式映射：前端值 → 后端值
const mapWorkForm = (formType: string): string => {
  const map: Record<string, string> = {
    'single-photo': 'single',  // 单张照 → single
    'group-photo': 'group'      // 组照 → group
  }
  return map[formType] || 'single'
}

// 组别映射：前端值 → 后端值
const mapGroup = (group: string): string => {
  const map: Record<string, string> = {
    'group1': 'group_a',  // 甲组(非专业组) → group_a
    'group2': 'group_b'   // 乙组（专业组） → group_b
  }
  return map[group] || 'group_a'
}

// 专业类别映射：前端值 → 后端中文值
const mapMajorCategory = (major?: string): string => {
  if (major === 'art') return '艺术类'
  if (major === 'non-art') return '非艺术类'
  if (major && (major === '艺术类' || major === '非艺术类')) {
    return major
  }
  return '艺术类'
}

const transformAuthors = (rows: RosterItem[]) => {
  return rows
    .filter(row => row.name && String(row.name).trim())
    .map(row => ({
      name: String(row.name || '').trim(),
      id_card_number: String(row.idNo || '').trim() || '000000000000000000',
      region: String(row.region || '').trim() || '未填写',
      school_name: String(row.school || '').trim() || '未填写',
      department: String(row.dept || '').trim() || '未填写',
      major_category: mapMajorCategory(row.majorType as string),
      major_name: String(row.major || '').trim() || '摄影专业',
      student_id: String(row.studentNo || '').trim() || '20200001',
      phone: String(row.phone || '').trim() || '13800000000'
    }))
}
```

**关键注意事项**：
- `width` 和 `length` 必须是**数字格式**，不是字符串（与设计作品不同）
- `group` 使用英文值（"group_a"、"group_b"），不是中文
- `work_form` 使用英文值（"single"、"group"），不是中文
- 字段名与其他作品类不同（如 `title` 而不是 `work_title`，`instructor` 而不是 `instructor_name`）

### 9. 微电影作品 (WorkMicrofilm.vue)

**接口地址**：`POST /micro-film/api/registrations/`（注意路径前缀不同）

**特殊字段**：
- `work_title`: 作品名称
- `instructor_1`, `instructor_2`, `instructor_3`: 三个指导教师字段（`instructor_3` 可以为空字符串）
- `contact_name`, `contact_phone`, `contact_address`: 联系信息
- `creation_date`: 创作时间（YYYY-MM-DD格式）
- `video_duration_minutes`, `video_duration_seconds`: 视频时长（分钟和秒，数字格式）
- `group`: 组别（需要映射：group1 → "group_a", group2 → "group_b"）
- `micro_film_video`: 微电影视频URL（不是 `work_photo` 或 `work_url`）
- `author_profile`: 作者简介（不是 `author_biography` 或 `author_bio`）
- `creation_description`: 创作说明

**花名册**：
- 作者信息（RosterBlock，使用 `authorColumns`）
- 作者数组字段名：`authors`
- **注意**：作者字段名与其他作品类不同：
  - `author_name`（不是 `name`）
  - `id_number`（不是 `id_card_number`）
  - `contact_info`（不是 `phone`）

**数据转换**：
```typescript
// 组别映射：前端值 → 后端值
const mapGroup = (group: string): string => {
  const map: Record<string, string> = {
    'group1': 'group_a',  // 甲组(非专业组) → group_a
    'group2': 'group_b'   // 乙组（专业组） → group_b
  }
  return map[group] || 'group_a'
}

// 专业类别映射：前端值 → 后端中文值
const mapMajorCategory = (major?: string): string => {
  if (major === 'art') return '艺术类'
  if (major === 'non-art') return '非艺术类'
  if (major && (major === '艺术类' || major === '非艺术类')) {
    return major
  }
  return '艺术类'
}

// 转换作者数据（注意字段名不同）
const transformAuthors = (rows: RosterItem[]) => {
  return rows
    .filter(row => row.name && String(row.name).trim())
    .map(row => ({
      author_name: String(row.name || '').trim(), // 注意：字段名是 author_name
      id_number: String(row.idNo || '').trim() || '000000000000000000', // 注意：字段名是 id_number
      region: String(row.region || '').trim() || '未填写',
      school_name: String(row.school || '').trim() || '未填写',
      department: String(row.dept || '').trim() || '未填写',
      major_category: mapMajorCategory(row.majorType as string),
      major_name: String(row.major || '').trim() || '数字媒体艺术',
      student_id: String(row.studentNo || '').trim() || '20200001',
      contact_info: String(row.phone || '').trim() || '13800000000' // 注意：字段名是 contact_info
    }))
}
```

**关键注意事项**：
- `video_duration_minutes` 和 `video_duration_seconds` 必须是**数字格式**
- `group` 使用英文值（"group_a"、"group_b"），不是中文
- `instructor_3` 可以为空字符串（如果未填写）
- **作者字段名与其他作品类不同**：
  - `author_name`（不是 `name`）
  - `id_number`（不是 `id_card_number`）
  - `contact_info`（不是 `phone`）
- `author_profile` 字段名（不是 `author_biography` 或 `author_bio`）

---

## 接口地址汇总

| 页面 | 接口地址 | 方法 |
|------|---------|------|
| 器乐报名 | `/api/instrumental/registrations/` | POST |
| 舞蹈报名 | `/api/dance/registrations/` | POST |
| 戏曲报名 | `/api/opera/registrations/` | POST |
| 声乐报名 | `/api/vocal/api/registrations/` | POST |
| 书法作品 | `/api/calligraphy/calligraphy-registrations/` | POST |
| 绘画作品 | `/painting/api/registrations/` | POST |
| 设计作品 | `/design/api/registrations/` | POST |
| 摄影作品 | `/photography/api/photography-registrations/` | POST |
| 微电影作品 | `/micro-film/api/registrations/` | POST |
| 文件上传（所有页面） | `/api/vocal/upload/` | POST |

---

## 错误处理

### 1. 400 Bad Request

**可能原因**：
- 字段格式不正确
- 缺少必需字段
- 字段值不符合要求

**处理方式**：
- 在 `request.ts` 的响应拦截器中统一处理
- 显示详细错误信息
- 控制台输出完整请求数据

### 2. 500 Internal Server Error

**可能原因**：
- 后端处理错误
- 数据格式问题
- 数据库操作失败

**处理方式**：
- 显示服务器错误提示
- 控制台输出错误详情
- 检查提交的数据格式

### 3. 401 Unauthorized

**可能原因**：
- Token 过期
- 未登录

**处理方式**：
- 自动跳转到登录页
- 清除用户存储

### 4. 文件上传失败

**处理方式**：
- 显示上传失败提示
- 允许重新上传
- 提供默认URL作为兜底

---

## 测试验证

### 通用测试流程

1. **填写基本信息**
   - 验证必填字段
   - 验证字段格式（中文姓名、11位手机号等）

2. **填写花名册**
   - 添加至少一个参演人员/作者
   - 验证字段格式（姓名、身份证号、手机号等）

3. **上传文件**
   - 选择文件后自动上传
   - 验证进度条显示
   - 验证成功标识显示

4. **提交表单**
   - 检查控制台日志
   - 验证接口调用成功
   - 验证返回数据

### 调试日志

在关键位置添加日志：

```typescript
// 提交前检查原始数据
console.log('[onSubmit] 原始花名册数据:', {
  teachers: teachers.value,
  members: members.value
})

// 检查转换后数据
console.log('[onSubmit] 转换后的花名册数据:', {
  guideTeachers: guideTeachersData,
  participants: participantsData
})

// 检查完整提交数据
console.log('[onSubmit] 提交的完整数据:', JSON.stringify(apiData, null, 2))
```

---

## 关键注意事项

### 1. 字段映射
- 前端字段名与后端字段名可能不同，必须使用转换函数
- 所有字段都要有默认值，确保不会提交 `undefined` 或空字符串

### 2. 数据格式
- 民族字段：必须将"汉"转换为"汉族"
- 性别字段：必须是 `'male'` 或 `'female'`
- 年龄字段：必须是数字类型

### 3. 必填字段
- `participants` 或 `authors` 数组至少需要有一个元素
- 基础字段（作品名称、联系人等）必填

### 4. 文件处理
- 使用 `FileUploadBlock` 组件统一管理上传
- 文件选择后自动上传，进度条从0%变为100%，显示成功标识
- `fileUploadRef.getFirstFileUrl()` 可读取已上传 URL
- 若仍未获取到 URL，使用默认地址兜底

### 5. 数据同步
- 使用 `TeacherBlock`、`MemberBlock`、`ConductorBlock` 组件确保数据正确同步
- 注意 `isSyncing` 标志的使用，防止循环更新

### 6. 接口路径差异
- 声乐报名：`/api/vocal/api/registrations/`（两个api）
- 绘画作品：`/painting/api/registrations/`（路径前缀不同）
- 设计作品：`/design/api/registrations/`（路径前缀不同）
- 摄影作品：`/photography/api/photography-registrations/`（路径前缀不同）
- 微电影作品：`/micro-film/api/registrations/`（路径前缀不同）
- 其他页面：`/api/{category}/registrations/`

---

## 总结

通用报名接口对接的核心要点：

1. **统一组件**：使用 `FileUploadBlock`、`TeacherBlock`、`MemberBlock` 等封装组件
2. **统一上传**：所有页面使用 `/api/vocal/upload/` 接口
3. **统一转换**：使用标准的数据转换函数处理花名册数据
4. **统一流程**：遵循标准的提交流程（验证 → 转换 → 上传 → 提交）
5. **特殊处理**：根据各页面的特殊需求进行定制化处理

按照本文档的通用流程，可以快速对接新的报名页面接口。
